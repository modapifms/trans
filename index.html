<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>Carte archéologique interactive</title>

    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">

    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
<div id="map"></div>

<script src="js/qgis2web_expressions.js"></script>
<script src="js/leaflet.js"></script>
<script src="js/L.Control.Layers.Tree.min.js"></script>
<script src="js/leaflet.rotatedMarker.js"></script>
<script src="js/leaflet.pattern.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>
<script src="js/rbush.min.js"></script>
<script src="js/labelgun.min.js"></script>
<script src="js/labels.js"></script>
<script src="js/leaflet.photon.js"></script>
<script src="js/leaflet-measure.js"></script>
<script src="js/proj4.js"></script>
<script src="js/proj4leaflet.js"></script>

<script src="data/2ndDcap_Fosses_0.js"></script>
<script src="data/2ndDcap_Foyer_1.js"></script>
<script src="data/DRAINSCONTEMPORAINS_2.js"></script>
<script src="data/Limite_emprise_3.js"></script>
<script src="data/Fosses_4.js"></script>
<script src="data/Foyer_5.js"></script>
<script src="data/Mur_6.js"></script>

<script>
// ======================================================
// 1. CRS EPSG:2154
// ======================================================
var crs = new L.Proj.CRS(
    'EPSG:2154',
    '+proj=lcc +lat_0=46.5 +lon_0=3 +lat_1=49 +lat_2=44 ' +
    '+x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs',
    {
        resolutions: [
            2800, 1400, 700, 350, 175, 84, 42, 21, 11.2, 5.6,
            2.8, 1.4, 0.7, 0.35, 0.14, 0.07, 0.03, 0.01,
            0.005, 0.001, 0.0005, 0.00025, 0.000125,
            0.0000625, 0.00003125, 0.000015625,
            0.0000078125, 0.00000390625, 0.000001953125
        ]
    }
);

// ======================================================
// 2. INITIALISATION CARTE
// ======================================================
var highlightLayer = null;

var map = L.map('map', {
    crs: crs,
    zoomControl: false,
    maxZoom: 32,
    minZoom: 1
});

L.control.zoom({ position: 'topleft' }).addTo(map);
new L.Hash(map);

map.setView([43.5062, 6.4879], 20);

// ======================================================
// 3. OUTILS
// ======================================================
new L.Control.Measure({
    position: 'topleft',
    primaryLengthUnit: 'meters',
    secondaryLengthUnit: 'kilometers',
    primaryAreaUnit: 'sqmeters',
    secondaryAreaUnit: 'hectares'
}).addTo(map);

var bounds_group = new L.featureGroup().addTo(map);

// ======================================================
// 4. STYLES ET POPUPS
// ======================================================
function popupSimple(feature, layer) {
    layer.bindPopup(
        '<table><tr><th>ID</th><td>' + feature.properties.id + '</td></tr></table>',
        { maxHeight: 300 }
    );
}

function styleFactory(color) {
    return {
        weight: 1,
        color: '#232323',
        fillOpacity: 1,
        fillColor: color,
        interactive: true
    };
}

// ======================================================
// 5. CHARGEMENT DES COUCHES
// ======================================================
var layer_2ndDcap_Fosses_0 = L.geoJson(json_2ndDcap_Fosses_0, {
    style: styleFactory('rgba(133,182,111,1)'),
    onEachFeature: popupSimple
}).addTo(map);

var layer_2ndDcap_Foyer_1 = L.geoJson(json_2ndDcap_Foyer_1, {
    style: styleFactory('rgba(243,166,178,1)'),
    onEachFeature: popupSimple
}).addTo(map);

var layer_DRAINSCONTEMPORAINS_2 = L.geoJson(json_DRAINSCONTEMPORAINS_2, {
    style: styleFactory('rgba(145,82,45,1)'),
    onEachFeature: popupSimple
}).addTo(map);

var layer_Limite_emprise_3 = L.geoJson(json_Limite_emprise_3, {
    style: { weight: 2, color: 'rgba(141,90,153,1)', fillOpacity: 0 },
    onEachFeature: popupSimple
}).addTo(map);

var layer_Fosses_4 = L.geoJson(json_Fosses_4, {
    style: styleFactory('rgba(255,158,23,1)'),
    onEachFeature: popupSimple
}).addTo(map);

var layer_Foyer_5 = L.geoJson(json_Foyer_5, {
    style: styleFactory('rgba(243,166,178,1)'),
    onEachFeature: popupSimple
}).addTo(map);

var layer_Mur_6 = L.geoJson(json_Mur_6, {
    style: styleFactory('rgba(152,125,183,1)'),
    onEachFeature: popupSimple
}).addTo(map);

bounds_group.addLayer(layer_2ndDcap_Fosses_0);
bounds_group.addLayer(layer_2ndDcap_Foyer_1);
bounds_group.addLayer(layer_DRAINSCONTEMPORAINS_2);
bounds_group.addLayer(layer_Limite_emprise_3);
bounds_group.addLayer(layer_Fosses_4);
bounds_group.addLayer(layer_Foyer_5);
bounds_group.addLayer(layer_Mur_6);

L.control.layers.tree(null, [
    { label: "Mur", layer: layer_Mur_6 },
    { label: "Foyer", layer: layer_Foyer_5 },
    { label: "Fosses", layer: layer_Fosses_4 },
    { label: "Limite emprise", layer: layer_Limite_emprise_3 },
    { label: "Drains contemporains", layer: layer_DRAINSCONTEMPORAINS_2 },
    { label: "2nd décap – Foyer", layer: layer_2ndDcap_Foyer_1 },
    { label: "2nd décap – Fosses", layer: layer_2ndDcap_Fosses_0 }
], { collapsed: true }).addTo(map);

// ======================================================
// 6. FONCTION DE ZOOM CORRIGÉE (VERSION ROBUSTE PROJ4)
// ======================================================
function zoomToFeatureById(targetId) {
    if (!targetId) return;

    let found = false;

    if (highlightLayer) {
        map.removeLayer(highlightLayer);
    }

    bounds_group.eachLayer(function(layer) {
        if (found) return;

        layer.eachLayer(function(f) {
            if (found) return;

            const id = f.feature && f.feature.properties && f.feature.properties.id;
            if (String(id) !== String(targetId)) return;

            // Création de la surbrillance
            highlightLayer = L.geoJson(f.feature, {
                style: {
                    color: '#FF0000',
                    weight: 5,
                    fillOpacity: 0.4,
                    dashArray: '5, 5',
                    interactive: false
                }
            }).addTo(map);

            // Correction Lambert-93 : On utilise le centre du polygone calculé par Leaflet
            // mais on applique un flyTo au centre des bounds pour forcer le repositionnement
            const bounds = f.getBounds();
            const center = bounds.getCenter();

            // Zoom agressif pour la précision archéologique (ajusté à 26)
            map.flyTo(center, 18, {
                animate: true,
                duration: 1.0
            });

            setTimeout(() => {
                f.openPopup();
            }, 1100);

            found = true;
        });
    });

    if (!found) {
        console.warn("ID non trouvé :", targetId);
    }
}

// ======================================================
// 7. GESTION DE L'URL
// ======================================================
window.addEventListener('load', function() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id') || params.get('search');
    if (id) {
        // Augmentation du délai pour garantir le chargement du GeoJSON
        setTimeout(() => zoomToFeatureById(id), 1200);
    }
});
</script>
</body>
</html>
