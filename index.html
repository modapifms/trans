<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title>Carte Archéologique</title>
    </head>
    <body>
        <div id="map"></div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.1/proj4leaflet.min.js"></script>

        <script src="data/2ndDcap_Fosses_0.js"></script>
        <script src="data/2ndDcap_Foyer_1.js"></script>
        <script src="data/DRAINSCONTEMPORAINS_2.js"></script>
        <script src="data/Limite_3.js"></script>
        <script src="data/Fosses_4.js"></script>
        <script src="data/Foyer_5.js"></script>
        <script src="data/Mur_6.js"></script>

        <script>
        // --- CONFIGURATION PROJECTION LAMBERT 93 ---
        var crs = new L.Proj.CRS('EPSG:2154',
          '+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
          {
            resolutions: [2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25]
          }
        );

        // --- INITIALISATION CARTE ---
        var map = L.map('map', {
            crs: crs,
            zoomControl: false, 
            maxZoom: 28, 
            minZoom: 1
        }).fitBounds([[43.50602564113576,6.487314472891667],[43.50651017086385,6.488530468047703]]);

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // Fonctions utilitaires
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                }
            }
        }

        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            primaryAreaUnit: 'sqmeters'
        });
        measureControl.addTo(map);
        
        var bounds_group = new L.featureGroup([]);

        // --- COUCHES ---

        // 0. 2ndDcap_Fosses
        function pop_2ndDcap_Fosses_0(feature, layer) {
            var popupContent = '<table><tr><th scope="row">id</th><td>' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id'])) : '') + '</td></tr></table>';
            layer.bindPopup(removeEmptyRowsFromPopupContent(popupContent, feature), {maxHeight: 400});
        }
        map.createPane('pane_2ndDcap_Fosses_0');
        map.getPane('pane_2ndDcap_Fosses_0').style.zIndex = 400;
        var layer_2ndDcap_Fosses_0 = new L.geoJson(json_2ndDcap_Fosses_0, {
            pane: 'pane_2ndDcap_Fosses_0',
            onEachFeature: pop_2ndDcap_Fosses_0,
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(255,158,23,1.0)', fillOpacity: 1, weight: 1 }
        });
        bounds_group.addLayer(layer_2ndDcap_Fosses_0);
        map.addLayer(layer_2ndDcap_Fosses_0);

        // 1. 2ndDcap_Foyer
        map.createPane('pane_2ndDcap_Foyer_1');
        map.getPane('pane_2ndDcap_Foyer_1').style.zIndex = 401;
        var layer_2ndDcap_Foyer_1 = new L.geoJson(json_2ndDcap_Foyer_1, {
            pane: 'pane_2ndDcap_Foyer_1',
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(190,207,80,1.0)', fillOpacity: 1, weight: 1 }
        });
        map.addLayer(layer_2ndDcap_Foyer_1);

        // 2. DRAINS
        map.createPane('pane_DRAINSCONTEMPORAINS_2');
        map.getPane('pane_DRAINSCONTEMPORAINS_2').style.zIndex = 402;
        var layer_DRAINSCONTEMPORAINS_2 = new L.geoJson(json_DRAINSCONTEMPORAINS_2, {
            pane: 'pane_DRAINSCONTEMPORAINS_2',
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(141,90,153,1.0)', fillOpacity: 1, weight: 1 }
        });
        map.addLayer(layer_DRAINSCONTEMPORAINS_2);

        // 3. LIMITE (Celle qui posait problème)
        map.createPane('pane_Limite_3');
        map.getPane('pane_Limite_3').style.zIndex = 403;
        var layer_Limite_3 = new L.geoJson(json_Limite_3, {
            pane: 'pane_Limite_3',
            style: { color: 'rgba(183,72,75,1.0)', weight: 2.0, fillOpacity: 0, interactive: true }
        });
        map.addLayer(layer_Limite_3);

        // 4. Fosses
        map.createPane('pane_Fosses_4');
        map.getPane('pane_Fosses_4').style.zIndex = 404;
        var layer_Fosses_4 = new L.geoJson(json_Fosses_4, {
            pane: 'pane_Fosses_4',
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(213,180,60,1.0)', fillOpacity: 1 }
        });
        map.addLayer(layer_Fosses_4);

        // 5. Foyer
        map.createPane('pane_Foyer_5');
        map.getPane('pane_Foyer_5').style.zIndex = 405;
        var layer_Foyer_5 = new L.geoJson(json_Foyer_5, {
            pane: 'pane_Foyer_5',
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(190,207,80,1.0)', fillOpacity: 1 }
        });
        map.addLayer(layer_Foyer_5);

        // 6. Mur
        map.createPane('pane_Mur_6');
        map.getPane('pane_Mur_6').style.zIndex = 406;
        var layer_Mur_6 = new L.geoJson(json_Mur_6, {
            pane: 'pane_Mur_6',
            style: { color: 'rgba(35,35,35,1.0)', fillColor: 'rgba(125,139,143,1.0)', fillOpacity: 1 }
        });
        map.addLayer(layer_Mur_6);

        // --- ARBRE DES COUCHES ---
        var overlaysTree = [
            {label: 'Mur', layer: layer_Mur_6},
            {label: 'Foyer', layer: layer_Foyer_5},
            {label: 'Fosses', layer: layer_Fosses_4},
            {label: 'Limite', layer: layer_Limite_3},
            {label: 'DRAINS', layer: layer_DRAINSCONTEMPORAINS_2},
            {label: '2nd-Décap_Foyer', layer: layer_2ndDcap_Foyer_1},
            {label: '2nd-Décap_Fosses', layer: layer_2ndDcap_Fosses_0}
        ];
        var lay = L.control.layers.tree(null, overlaysTree, {collapsed: true}).addTo(map);

        // --- RECHERCHE PAR URL ---
        function searchFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchValue = urlParams.get('search');
            if (searchValue) {
                var layers = [layer_Mur_6, layer_Foyer_5, layer_Fosses_4, layer_Limite_3, layer_DRAINSCONTEMPORAINS_2, layer_2ndDcap_Foyer_1, layer_2ndDcap_Fosses_0];
                var found = false;
                layers.forEach(function(layer) {
                    layer.eachLayer(function(featureLayer) {
                        if (featureLayer.feature.properties.id && String(featureLayer.feature.properties.id) === searchValue) {
                            if (featureLayer.getBounds) {
                                map.fitBounds(featureLayer.getBounds(), {maxZoom: 25});
                            } else {
                                map.setView(featureLayer.getLatLng(), 25);
                            }
                            featureLayer.openPopup();
                            found = true;
                        }
                    });
                });
            }
        }
        searchFromUrl();
        </script>
    </body>
</html>
